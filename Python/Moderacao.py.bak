import discord
from discord.ext import commands
import json
import os
import asyncio
from Python.logger import send_log
from collections import defaultdict, deque
from datetime import datetime, timedelta

warns_path = 'warns.json'

ALLOWED_ROLES = ["Rei da cocada preta", "Admin", "Moderador"]

# Sistema de spam
spam_tracker = defaultdict(lambda: deque(maxlen=5))  # Armazena atÃ© 5 mensagens por autor

def load_warns():
    if os.path.exists(warns_path):
        with open(warns_path, 'r') as f:
            return json.load(f)
    return {}

def save_warns(warns):
    with open(warns_path, 'w') as f:
        json.dump(warns, f, indent=4)

def tem_cargo_autorizado(membro):
    return any(role.name in ALLOWED_ROLES for role in membro.roles)

class Moderacao(commands.Cog):
    def __init__(self, bot):
        self.bot = bot
        self.warns = load_warns()

    @commands.Cog.listener()
    async def on_message(self, message):
        if message.author.bot:
            return

        agora = datetime.utcnow()
        spam_tracker[message.author.id].append(agora)

        if len(spam_tracker[message.author.id]) >= 5:
            intervalo = agora - spam_tracker[message.author.id][0]
            if intervalo < timedelta(seconds=10):
                user_id = str(message.author.id)
                self.warns.setdefault(user_id, []).append("Spam detectado automaticamente.")
                save_warns(self.warns)
                total_warns = len(self.warns[user_id])
                await message.channel.send(f"âš ï¸ {message.author.mention} foi advertido por spam automÃ¡tico. Total: {total_warns}")
                await send_log(message.guild, f"âš ï¸ {message.author.mention} foi advertido automaticamente por spam. Total: {total_warns}")
                if total_warns == 3:
                    role = discord.utils.get(message.guild.roles, name="Mutado")
                    if role:
                        await message.author.add_roles(role, reason="Mute automÃ¡tico - 3 warns")
                        await send_log(message.guild, f"ğŸ”‡ {message.author.mention} foi mutado automaticamente (3 warns).")

    async def checar_autorizacao(self, ctx):
        if not tem_cargo_autorizado(ctx.author):
            await ctx.send("âŒ VocÃª nÃ£o tem permissÃ£o para usar este comando.")
            return False
        return True

    @commands.command(name="warn")
    async def warn(self, ctx, member: discord.Member, *, reason: str = "Sem motivo."):
        if not await self.checar_autorizacao(ctx): return

        user_id = str(member.id)
        self.warns.setdefault(user_id, []).append(reason)
        save_warns(self.warns)

        total_warns = len(self.warns[user_id])

        await ctx.send(f"âš ï¸ {member.mention} foi advertido. Total: {total_warns}")
        try:
            await member.send(f"âš ï¸ VocÃª foi advertido no servidor **{ctx.guild.name}**. Motivo: {reason}")
        except:
            pass
        await send_log(ctx.guild, f"âš ï¸ {member.mention} foi advertido por {ctx.author.mention}. Motivo: {reason} (Total: {total_warns})")

        if total_warns == 3:
            role = discord.utils.get(ctx.guild.roles, name="Mutado")
            if role:
                await member.add_roles(role, reason="Mute automÃ¡tico - 3 warns")
                await send_log(ctx.guild, f"ğŸ”‡ {member.mention} foi mutado automaticamente (3 warns).")

    @commands.command(name="verwarns")
    async def verwarns(self, ctx, member: discord.Member):
        if not await self.checar_autorizacao(ctx): return

        user_id = str(member.id)
        user_warns = self.warns.get(user_id, [])

        if not user_warns:
            await ctx.send(f"âœ… {member.mention} nÃ£o possui advertÃªncias.")
        else:
            msg = f"ğŸ“‹ AdvertÃªncias de {member.mention}:\n"
            for i, reason in enumerate(user_warns, 1):
                msg += f"{i}. {reason}\n"
            await ctx.send(msg)

    @commands.command(name="clearwarns")
    async def clearwarns(self, ctx, member: discord.Member):
        if not await self.checar_autorizacao(ctx): return

        user_id = str(member.id)
        if user_id in self.warns:
            del self.warns[user_id]
            save_warns(self.warns)
            await ctx.send(f"ğŸ§¹ AdvertÃªncias de {member.mention} foram removidas.")
            await send_log(ctx.guild, f"ğŸ§¹ AdvertÃªncias de {member.mention} foram **limpas** por {ctx.author.mention}.")
        else:
            await ctx.send(f"âœ… {member.mention} nÃ£o tinha advertÃªncias para remover.")

    @commands.command(name="unwarn")
    async def unwarn(self, ctx, member: discord.Member, index: int):
        if not await self.checar_autorizacao(ctx): return

        user_id = str(member.id)
        if user_id not in self.warns or index < 1 or index > len(self.warns[user_id]):
            await ctx.send("âŒ Ãndice invÃ¡lido ou usuÃ¡rio sem advertÃªncias.")
            return

        removed = self.warns[user_id].pop(index - 1)
        if not self.warns[user_id]:
            del self.warns[user_id]

        save_warns(self.warns)
        await ctx.send(f"âœ… AdvertÃªncia `{removed}` removida de {member.mention}.")
        await send_log(ctx.guild, f"âœ‚ï¸ AdvertÃªncia removida de {member.mention} por {ctx.author.mention}: `{removed}`")

    @commands.command(name="warnslist")
    async def warnslist(self, ctx):
        if not await self.checar_autorizacao(ctx): return

        if not self.warns:
            await ctx.send("âœ… NinguÃ©m possui advertÃªncias no momento.")
            return

        msg = "**ğŸ“‹ Lista de usuÃ¡rios com advertÃªncias:**\n"
        for user_id, reasons in self.warns.items():
            membro = ctx.guild.get_member(int(user_id))
            nome = membro.mention if membro else f"`{user_id}`"
            msg += f"â€¢ {nome}: {len(reasons)} warns\n"
        await ctx.send(msg)

    @commands.command(name="setupmute")
    async def setupmute(self, ctx):
        if not await self.checar_autorizacao(ctx): return

        guild = ctx.guild
        mutado = discord.utils.get(guild.roles, name="Mutado")

        if not mutado:
            mutado = await guild.create_role(name="Mutado", reason="Cargo para silenciar usuÃ¡rios com 3 warns")
            await ctx.send("âœ… Cargo `Mutado` criado.")
        else:
            await ctx.send("ğŸ” Cargo `Mutado` jÃ¡ existe. Atualizando permissÃµes...")

        for canal in guild.channels:
            try:
                await canal.set_permissions(mutado,
                    send_messages=False,
                    speak=False,
                    add_reactions=False,
                    send_messages_in_threads=False
                )
            except Exception as e:
                print(f"[ERRO] Canal {canal.name}: {e}")

        await ctx.send("ğŸ”’ PermissÃµes do cargo `Mutado` aplicadas.")
        await send_log(guild, f"ğŸ”§ `setupmute` usado por {ctx.author.mention}. Cargo configurado.")

    @commands.command(name="mute")
    async def mute(self, ctx, member: discord.Member, tempo: int = 0, *, motivo: str = "Sem motivo."):
        if not await self.checar_autorizacao(ctx): return

        role = discord.utils.get(ctx.guild.roles, name="Mutado")
        if not role:
            await ctx.send("âŒ Cargo `Mutado` nÃ£o encontrado. Use !setupmute primeiro.")
            return

        await member.add_roles(role, reason=motivo)
        await ctx.send(f"ğŸ”‡ {member.mention} foi mutado. {'Tempo: ' + str(tempo) + 'min.' if tempo > 0 else 'Tempo indefinido.'}")
        await send_log(ctx.guild, f"ğŸ”‡ {member.mention} foi mutado por {ctx.author.mention}. Motivo: {motivo}")

        if tempo > 0:
            await asyncio.sleep(tempo * 60)
            if role in member.roles:
                await member.remove_roles(role)
                await send_log(ctx.guild, f"ğŸ”Š {member.mention} foi desmutado automaticamente apÃ³s {tempo} minutos.")

    @commands.command(name="unmute")
    async def unmute(self, ctx, member: discord.Member):
        if not await self.checar_autorizacao(ctx): return

        role = discord.utils.get(ctx.guild.roles, name="Mutado")
        if not role or role not in member.roles:
            await ctx.send("âœ… Esse usuÃ¡rio nÃ£o estÃ¡ mutado.")
            return

        await member.remove_roles(role)
        await ctx.send(f"ğŸ”Š {member.mention} foi desmutado.")
        await send_log(ctx.guild, f"ğŸ”Š {member.mention} foi desmutado por {ctx.author.mention}.")

    @commands.command(name="limpar")
    async def limpar(self, ctx, quantidade: int):
        if not await self.checar_autorizacao(ctx): return

        await ctx.channel.purge(limit=quantidade + 1)
        msg = await ctx.send(f"ğŸ§¹ {quantidade} mensagens apagadas.")
        await asyncio.sleep(3)
        await msg.delete()
        await send_log(ctx.guild, f"ğŸ§¹ {quantidade} mensagens foram apagadas por {ctx.author.mention} em {ctx.channel.mention}.")

    @commands.command(name="ban")
    async def ban(self, ctx, member: discord.Member, *, reason: str = "Sem motivo."):
        if not await self.checar_autorizacao(ctx): return

        try:
            await member.ban(reason=reason)
            await ctx.send(f"ğŸ”¨ {member.mention} foi banido.")
            await send_log(ctx.guild, f"ğŸ”¨ {member.mention} foi banido por {ctx.author.mention}. Motivo: {reason}")
        except discord.Forbidden:
            await ctx.send("âŒ NÃ£o tenho permissÃ£o para banir esse usuÃ¡rio.")

    @commands.command(name="kick")
    async def kick(self, ctx, member: discord.Member, *, reason: str = "Sem motivo."):
        if not await self.checar_autorizacao(ctx): return

        try:
            await member.kick(reason=reason)
            await ctx.send(f"ğŸ‘¢ {member.mention} foi expulso do servidor.")
            await send_log(ctx.guild, f"ğŸ‘¢ {member.mention} foi expulso por {ctx.author.mention}. Motivo: {reason}")
        except discord.Forbidden:
            await ctx.send("âŒ NÃ£o tenho permissÃ£o para expulsar esse usuÃ¡rio.")

async def setup(bot):
    await bot.add_cog(Moderacao(bot))
