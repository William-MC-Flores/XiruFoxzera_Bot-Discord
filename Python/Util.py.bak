import discord
from discord.ext import commands
from discord.ui import View, Button
import platform
import asyncio
import random
from datetime import datetime
from Python.logger import send_log

class VotacaoView(View):
    def __init__(self):
        super().__init__(timeout=None)
        self.votos_sim = 0
        self.votos_nao = 0

    @discord.ui.button(label="ğŸ‘ Sim", style=discord.ButtonStyle.success, custom_id="sim")
    async def botao_sim(self, interaction: discord.Interaction, button: Button):
        self.votos_sim += 1
        await interaction.response.edit_message(embed=self._criar_embed())

    @discord.ui.button(label="ğŸ‘ NÃ£o", style=discord.ButtonStyle.danger, custom_id="nao")
    async def botao_nao(self, interaction: discord.Interaction, button: Button):
        self.votos_nao += 1
        await interaction.response.edit_message(embed=self._criar_embed())

    def _criar_embed(self):
        embed = discord.Embed(title="ğŸ“Š VotaÃ§Ã£o",
                              description=f"ğŸ‘ Sim: **{self.votos_sim}**\nğŸ‘ NÃ£o: **{self.votos_nao}**",
                              color=discord.Color.blue())
        return embed

class Utilitarios(commands.Cog):
    def __init__(self, bot):
        self.bot = bot

    @commands.command(name="ping")
    async def ping(self, ctx):
        await ctx.send("ğŸ“ Pong!")
        await send_log(ctx.guild, f"ğŸ“± Comando `ping` usado por {ctx.author.mention}")

    @commands.command(name="avatar")
    async def avatar(self, ctx, membro: discord.Member = None):
        membro = membro or ctx.author
        avatar_url = membro.avatar.url if membro.avatar else membro.default_avatar.url
        embed = discord.Embed(title=f"ğŸ–¼ Avatar de {membro}", color=discord.Color.blurple())
        embed.set_image(url=avatar_url)
        await ctx.send(embed=embed)
        await send_log(ctx.guild, f"ğŸ–¼ Comando `avatar` usado por {ctx.author.mention} para {membro.mention}")

    @commands.command(name="userinfo")
    async def userinfo(self, ctx, membro: discord.Member = None):
        membro = membro or ctx.author
        cargos = ", ".join([role.mention for role in membro.roles[1:]]) or "Nenhum"
        criado_em = membro.created_at.strftime('%d/%m/%Y %H:%M')
        entrou_em = membro.joined_at.strftime('%d/%m/%Y %H:%M') if membro.joined_at else "Desconhecido"
        embed = discord.Embed(title=f"ğŸ‘¤ InformaÃ§Ãµes de {membro}", color=discord.Color.green())
        embed.set_thumbnail(url=membro.avatar.url if membro.avatar else membro.default_avatar.url)
        embed.add_field(name="ğŸ†” ID", value=membro.id, inline=True)
        embed.add_field(name="ğŸ’¬ Nome", value=membro.name, inline=True)
        embed.add_field(name="ğŸ½ Apelido", value=membro.display_name, inline=True)
        embed.add_field(name="ğŸ“… Conta criada em", value=criado_em, inline=False)
        embed.add_field(name="ğŸšª Entrou no servidor em", value=entrou_em, inline=False)
        embed.add_field(name="ğŸ“Œ Cargos", value=cargos, inline=False)
        await ctx.send(embed=embed)
        await send_log(ctx.guild, f"ğŸ‘¤ Comando `userinfo` usado por {ctx.author.mention} para {membro.mention}")

    @commands.command(name="serverinfo")
    async def serverinfo(self, ctx):
        guild = ctx.guild
        criado_em = guild.created_at.strftime('%d/%m/%Y %H:%M')
        embed = discord.Embed(title=f"ğŸ  Info do servidor {guild.name}", color=discord.Color.orange())
        embed.set_thumbnail(url=guild.icon.url if guild.icon else discord.Embed.Empty)
        embed.add_field(name="ğŸ†” ID", value=guild.id, inline=True)
        embed.add_field(name="ğŸ‘‘ Dono", value=guild.owner.mention, inline=True)
        embed.add_field(name="ğŸ“… Criado em", value=criado_em, inline=False)
        embed.add_field(name="ğŸ‘¥ Membros", value=guild.member_count, inline=True)
        embed.add_field(name="ğŸ“ Canais", value=len(guild.channels), inline=True)
        embed.add_field(name="ğŸ“Œ Cargos", value=len(guild.roles), inline=True)
        await ctx.send(embed=embed)
        await send_log(ctx.guild, f"ğŸ  Comando `serverinfo` usado por {ctx.author.mention}")

    @commands.command(name="botinfo")
    async def botinfo(self, ctx):
        embed = discord.Embed(title="ğŸ¤– Info do Bot", color=discord.Color.purple())
        embed.add_field(name="ğŸ“± LatÃªncia", value=f"{round(self.bot.latency * 1000)}ms", inline=True)
        embed.add_field(name="ğŸ“¦ Plataforma", value=platform.system(), inline=True)
        embed.add_field(name="ğŸ’ª Criador", value="Will Flores", inline=True)
        embed.add_field(name="ğŸ“œ Total de comandos", value=len(self.bot.commands), inline=False)
        await ctx.send(embed=embed)
        await send_log(ctx.guild, f"ğŸ¤– Comando `botinfo` usado por {ctx.author.mention}")

    @commands.command(name="say")
    @commands.has_permissions(manage_messages=True)
    async def say(self, ctx, *, mensagem):
        await ctx.message.delete()
        await ctx.send(mensagem)
        await send_log(ctx.guild, f"ğŸ“£ Comando `say` usado por {ctx.author.mention}: `{mensagem}`")

    @commands.command(name="votacao")
    async def votacao(self, ctx):
        view = VotacaoView()
        embed = view._criar_embed()
        await ctx.send(embed=embed, view=view)
        await send_log(ctx.guild, f"ğŸ“Š VotaÃ§Ã£o iniciada por {ctx.author.mention}")

    @commands.command(name="sorteio")
    @commands.has_permissions(manage_messages=True)
    async def sorteio(self, ctx, tempo: int = 10):
        embed = discord.Embed(
            title="ğŸ‰ Sorteio Iniciado!",
            description=f"Reaja com ğŸ‰ para participar!\nSorteio termina em **{tempo} segundos**.",
            color=discord.Color.gold()
        )
        msg = await ctx.send(embed=embed)
        await msg.add_reaction("ğŸ‰")
        await asyncio.sleep(tempo)
        msg = await ctx.channel.fetch_message(msg.id)
        users = [u async for u in msg.reactions[0].users() if not u.bot]
        if not users:
            await ctx.send("âŒ NinguÃ©m participou do sorteio.")
        else:
            vencedor = random.choice(users)
            await ctx.send(f"ğŸ‰ ParabÃ©ns {vencedor.mention}, vocÃª venceu o sorteio!")
            await send_log(ctx.guild, f"ğŸ Sorteio feito por {ctx.author.mention}. Vencedor: {vencedor.mention}")

    @commands.command(name="coinflip")
    async def coinflip(self, ctx):
        resultado = random.choice(["ğŸª™ Cara", "ğŸª™ Coroa"])
        await ctx.send(f"Resultado: **{resultado}**")
        await send_log(ctx.guild, f"ğŸª™ Coinflip usado por {ctx.author.mention}: {resultado}")

    @commands.command(name="dado")
    async def dado(self, ctx):
        numero = random.randint(1, 6)
        await ctx.send(f"ğŸ² VocÃª rolou: **{numero}**")
        await send_log(ctx.guild, f"ğŸ² Dado usado por {ctx.author.mention}: {numero}")

    @commands.command(name="8ball")
    async def oito_ball(self, ctx, *, pergunta):
        respostas = ["Sim", "NÃ£o", "Talvez", "Provavelmente", "Com certeza", "Nunca", "Acho que sim", "Pergunte depois"]
        resposta = random.choice(respostas)
        await ctx.send(f"ğŸ± Pergunta: {pergunta}\nResposta: **{resposta}**")
        await send_log(ctx.guild, f"ğŸ± 8ball usado por {ctx.author.mention}")

    @commands.command(name="embed")
    @commands.has_permissions(manage_messages=True)
    async def embed(self, ctx, titulo: str, *, descricao: str):
        embed = discord.Embed(title=titulo, description=descricao, color=discord.Color.random())
        await ctx.send(embed=embed)
        await send_log(ctx.guild, f"ğŸ§± Embed criado por {ctx.author.mention}: {titulo}")

async def setup(bot):
    await bot.add_cog(Utilitarios(bot))
